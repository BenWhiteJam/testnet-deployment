name: Deploy on Kubernetes Cluster
on:
  push:
    branches:
      - main
  repository_dispatch:
    types: [run-k8s-deployment]
jobs:
  run-k8s-deployment:
    runs-on: ubuntu-latest
    env:
      ACTIONS_ALLOW_UNSECURE_COMMANDS: true
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_K8S_ACCESS_KEY }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_K8S_SECRET_KEY }}
    steps:
      - uses: actions/checkout@v2
        with:
          ref: ${{ github.event.client_payload.ref }}
      - run: echo ${{ github.event.client_payload.sha }}
      - name: Install kubectl
        run: |
          sudo apt-get update
          sudo apt-get install -y apt-transport-https ca-certificates curl
          sudo curl -fsSLo /usr/share/keyrings/kubernetes-archive-keyring.gpg https://packages.cloud.google.com/apt/doc/apt-key.gpg
          echo "deb [signed-by=/usr/share/keyrings/kubernetes-archive-keyring.gpg] https://apt.kubernetes.io/ kubernetes-xenial main" | sudo tee /etc/apt/sources.list.d/kubernetes.list
          sudo apt-get update
          sudo apt-get install -y kubectl
      - name: Sleep for 60 seconds
        run: sleep 60
      - name: Configure AWS CLI and K8s
        run: |
          sudo apt-get install awscli
          aws configure set aws_access_key_id ${{ env.AWS_ACCESS_KEY_ID }}; aws configure set aws_secret_access_key ${{ env.AWS_SECRET_ACCESS_KEY }}; aws configure set default.region eu-west-1
      - name: configure kubernetes cluster
        run: aws eks --region eu-west-1 update-kubeconfig --name hydradx-c
      - name: Delete deployments
        run: kubectl delete --all deployments --namespace=hydra-ui-test
      - name: ls and where am I
        run: |
          ls
          pwd  
      - name: Cleanup volumes
        run: |
          kubectl apply -f cleanup-1.yaml
          kubectl apply -f cleanup-2.yaml
          kubectl apply -f cleanup-3.yaml
          kubectl apply -f cleanup-4.yaml
          kubectl apply -f cleanup-5.yaml

